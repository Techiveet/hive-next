datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String   @id
  name          String   @db.Text
  email         String
  emailVerified Boolean  @default(false)
  image         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  isActive Boolean @default(true)

  // multi-tenant & rbac relations
  tenantMemberships UserTenant[]
  userRoles         UserRole[]

  // file manager relations
  folders  Folder[]  @relation("UserFolders")
  files    File[]    @relation("UserFiles")
  sessions Session[]
  accounts Account[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId(length: 191)])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId(length: 191)])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier(length: 191)])
  @@map("verification")
}

// =====================
//  MULTI-TENANT + RBAC
// =====================

enum RoleScope {
  CENTRAL // central platform roles (tenantId = null)
  TENANT // tenant-scoped roles  (tenantId = specific tenant)
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     UserTenant[]
  userRoles UserRole[]
  domains   TenantDomain[]

  // file manager relations
  folders     Folder[]
  files       File[]
  roles       Role[]
  permissions Permission[]
}

model TenantDomain {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  domain    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Role {
  id    Int       @id @default(autoincrement())
  key   String
  name  String
  scope RoleScope

  // global (null) or tenant-local
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles   UserRole[]
  permissions RolePermission[]

  // key is unique PER tenant; global roles have tenantId = null
  @@unique([tenantId, key])
}

model Permission {
  id   Int    @id @default(autoincrement())
  key  String
  name String

  // global (null) or tenant-local
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles RolePermission[]

  @@unique([tenantId, key])
}

model RolePermission {
  roleId       Int
  permissionId Int

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserTenant {
  id       String  @id @default(cuid())
  userId   String
  tenantId String
  isOwner  Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
}

model UserRole {
  id       String  @id @default(cuid())
  userId   String
  roleId   Int
  tenantId String? // null = central role

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, roleId, tenantId])
}

// =====================
//   FILE MANAGER
// =====================

model Folder {
  id   String @id @default(cuid())
  name String

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Folder?  @relation("FolderChildren", fields: [parentId], references: [id])
  children Folder[] @relation("FolderChildren")

  createdById String
  createdBy   User   @relation("UserFolders", fields: [createdById], references: [id])

  files     File[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model File {
  id       String @id @default(cuid())
  name     String
  size     Int
  mimeType String

  url String @db.LongText

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  folderId String?
  folder   Folder? @relation(fields: [folderId], references: [id])

  ownerId String
  owner   User   @relation("UserFiles", fields: [ownerId], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isFavorite Boolean   @default(false)
  deletedAt  DateTime?

  @@index([tenantId])
}

// =====================
//   FILE SETTINGS
// =====================

model FileManagerSettings {
  id                        String  @id @default("global")
  maxFileSizeMb             Int     @default(50)
  allowedExtensions         Json
  autoEmptyRecycleBinDays   Int     @default(30)
  requireDeleteConfirmation Boolean @default(true)
  allowPublicSharing        Boolean @default(false)
}
