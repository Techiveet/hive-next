// prisma/schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =====================
//        USER / AUTH
// =====================

model User {
  id            String    @id
  name          String    @db.Text
  email         String
  emailVerified Boolean   @default(false)
  
  // Custom Security Field
  twoFactorEnabled Boolean @default(false)

  // make both large enough for long URLs / base64
  image         String?   @db.LongText
  avatarUrl     String?   @db.LongText

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true)

  // multi-tenant & rbac relations
  tenantMemberships UserTenant[]
  userRoles         UserRole[]

  // file manager relations
  folders  Folder[] @relation("UserFolders")
  files    File[]   @relation("UserFiles")

  sessions            Session[]
  accounts            Account[]
  passwordSetupTokens PasswordSetupToken[]

  @@unique([email])
  @@map("user")
}

// 1. Update Session Model
model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  // ✅ FIX: Bumped to v4
  @@index([userId(length: 191)], map: "session_user_idx_v4")
  @@map("session")
}

// 2. Update Account Model
model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([providerId, accountId])
  // ✅ FIX: Bumped to v4
  @@index([userId], map: "account_user_idx_v4")
  @@map("account")
}

// 3. Update Verification Model
model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // ✅ FIX: Bumped to v4
  @@index([identifier(length: 191)], map: "verification_identifier_idx_v4")
  @@map("verification")
}

// 4. Update PasswordSetupToken Model
model PasswordSetupToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // ✅ FIX: Bumped to v4 (This was the specific error)
  @@index([userId(length: 191)], map: "password_setup_token_user_idx_v4")
  @@map("password_setup_token")
}

// =====================
//    MULTI-TENANT + RBAC
// =====================

enum RoleScope {
  CENTRAL // central platform roles (tenantId = null)
  TENANT  // tenant-scoped roles  (tenantId = specific tenant)
}

enum EmailProvider {
  RESEND
  SMTP
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true) 

  users       UserTenant[]
  userRoles   UserRole[]
  domains     TenantDomain[]
  folders     Folder[]
  files       File[]
  roles       Role[]
  permissions Permission[]

  // one settings row per tenant
  appSettings         AppSettings?
  brandSettings       BrandSettings?
  companySettings     CompanySettings?
  emailSettings       EmailSettings?
  fileManagerSettings FileManagerSettings?
  
  // ✅ ADDED: Storage Settings relation
  storageSettings     StorageSettings?

  // ✅ BACKUP & LANGUAGES
  backupSettings      BackupSettings?
  backups             BackupHistory[]
  languages           Language[]
  
  // ✅ ADDED: IP Settings relation (Fixes your error)
  ipSettings          IpSettings?
}

model TenantDomain {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  domain    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Role {
  id    Int       @id @default(autoincrement())
  key   String
  name  String
  scope RoleScope

  // global (null) or tenant-local
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles   UserRole[]
  permissions RolePermission[]

  // key is unique PER tenant; global roles have tenantId = null
  @@unique([tenantId, key])
}

model Permission {
  id   Int    @id @default(autoincrement())
  key  String
  name String

  // global (null) or tenant-local
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles RolePermission[]

  @@unique([tenantId, key])
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserTenant {
  id       String  @id @default(cuid())
  userId   String
  tenantId String
  isOwner  Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
}

model UserRole {
  id       String  @id @default(cuid())
  userId   String
  roleId   Int
  tenantId String? // null = central role

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, roleId, tenantId])
}

// =====================
//    FILE MANAGER
// =====================

model Folder {
  id   String @id @default(cuid())
  name String

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Folder?  @relation("FolderChildren", fields: [parentId], references: [id])
  children Folder[] @relation("FolderChildren")

  createdById String
  createdBy   User   @relation("UserFolders", fields: [createdById], references: [id])

  files     File[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model File {
  id       String @id @default(cuid())
  name     String
  size     Int
  mimeType String

  url String @db.LongText

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  folderId String?
  folder   Folder? @relation(fields: [folderId], references: [id])

  ownerId String
  owner   User   @relation("UserFiles", fields: [ownerId], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isFavorite Boolean   @default(false)
  deletedAt  DateTime?

  @@index([tenantId])
}

// =====================
//    FILE SETTINGS
// =====================

model FileManagerSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  maxFileSizeMb             Int     @default(50)
  allowedExtensions         Json    @default("[]") // Store as array of strings
  autoEmptyRecycleBinDays   Int     @default(30)
  requireDeleteConfirmation Boolean @default(true)
  allowPublicSharing        Boolean @default(false)
}

// =====================
//    APP SETTINGS
// =====================

model AppSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  timezone               String  @default("UTC")
  locale                 String  @default("en")
  dateFormat             String  @default("yyyy-MM-dd")
  timeFormat             String  @default("HH:mm")
  weekStartsOn           Int     @default(1) // 1 = Monday
  defaultTheme           String  @default("system") // "light" | "dark" | "system"
  allowUserThemeOverride Boolean @default(true)
  enforceTwoFactor       Boolean @default(false)
  sessionTimeout         Int     @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BrandSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  titleText  String @default("Hive")
  footerText String @default("Powered by Hive")

  logoLightUrl String? @db.LongText
  logoDarkUrl  String? @db.LongText
  faviconUrl   String? @db.LongText

  sidebarIconUrl String? @db.LongText

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CompanySettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  companyName        String
  legalName          String?
  email              String?
  phone              String?
  website            String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  country            String?
  taxId              String?
  registrationNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider     EmailProvider @default(RESEND)
  fromName     String
  fromEmail    String
  replyToEmail String?

  // Optional SMTP config – non-secret
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpSecurity String? // "tls" | "ssl" | "none"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================
//    LOCALIZATION
// =====================

model Language {
  id       String  @id @default(cuid())
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code      String // e.g., "am", "fr", "es"
  name      String // e.g., "Amharic", "French"
  isDefault Boolean @default(false)
  isEnabled Boolean @default(true)

  // Stores the actual translations
  translations Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
}

// =====================
//    BACKUP SYSTEM
// =====================

model BackupSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  enabled   Boolean @default(false)
  frequency String  @default("DAILY") // DAILY, WEEKLY, MONTHLY
  time      String  @default("00:00") // 24h format
  retention Int     @default(7)       // How many backups to keep

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BackupHistory {
  id       String  @id @default(cuid())
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  filename String
  path     String  @db.Text // Local path or S3 URL
  size     BigInt  // Bytes
  status   String  // SUCCESS, FAILED
  type     String  // MANUAL, AUTOMATIC

  createdAt DateTime @default(now())

  @@index([tenantId])
}

// =====================
//    CRON JOB REGISTRY
// =====================

model SystemCron {
  id          String   @id @default(cuid())
  key         String   @unique // e.g. "backup-daily"
  name        String
  description String?
  
  schedule    String   // e.g. "0 0 * * *"
  url         String   // e.g. "/api/cron/backup"
  
  lastRunAt   DateTime?
  lastStatus  String?
  lastMessage String?  @db.Text
  
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =====================
//    STORAGE SETTINGS
// =====================

model StorageSettings {
  id        String   @id @default(cuid())
  tenantId  String?  @unique
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Provider Type
  provider  String   @default("LOCAL") // LOCAL, S3, R2, SPACES, GDRIVE

  // S3 / R2 / Spaces Credentials
  accessKeyId     String? @db.Text
  secretAccessKey String? @db.Text
  endpoint        String? @db.Text // Needed for R2/Spaces (e.g., nyc3.digitaloceanspaces.com)
  region          String? @db.Text
  bucket          String? @db.Text
  
  // Google Drive (Service Account JSON)
  gdriveJson      String? @db.Text 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================
//    IP RESTRICTION
// =====================

model IpSettings {
  id        String   @id @default(cuid())
  tenantId  String?  @unique
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  enabled   Boolean  @default(false)
  
  // ✅ ADD THIS MISSING FIELD
  strategy  String   @default("ALLOW") // "ALLOW" or "BLOCK"
  
  allowList Json     @default("[]") 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}