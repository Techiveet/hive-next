datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =====================
//        USER / AUTH
// =====================

model User {
  id            String   @id
  name          String   @db.Text
  email         String
  emailVerified Boolean  @default(false)

  sentEmails     Email[]           @relation("Sender")
  receivedEmails EmailRecipient[]

  // Custom Security Field
  twoFactorEnabled       Boolean  @default(false)
  twoFactorSecret        String?  @db.Text
  twoFactorRecoveryCodes String?  @db.Text

  // make both large enough for long URLs / base64
  image     String? @db.LongText
  avatarUrl String? @db.LongText

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true)

  // multi-tenant & rbac relations
  tenantMemberships UserTenant[]
  userRoles         UserRole[]

  // PGP
  pgpPublicKey        String? @db.LongText
  encryptedPrivateKey String? @db.LongText

  // file manager relations
  folders Folder[] @relation("UserFolders")
  files   File[]   @relation("UserFiles")

  // Email templates
  emailTemplates EmailTemplate[]

  sessions            Session[]
  accounts            Account[]
  passwordSetupTokens PasswordSetupToken[]

  @@unique([email])
  @@index([email(length: 191)])
  @@index([createdAt])
  @@map("user")
}

// =====================
//        EMAIL
// =====================

model Email {
  id      String @id @default(uuid())
  subject String @db.Text
  body    String @db.LongText

  senderId String
  sender   User   @relation("Sender", fields: [senderId], references: [id])

  recipients   EmailRecipient[]
  isStarred    Boolean @default(false)
  senderFolder String  @default("sent")
  isE2EE       Boolean @default(false)

  attachments EmailAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId, senderFolder, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([isE2EE])
}

model EmailTemplate {
  id        String  @id @default(cuid())
  name      String
  subject   String
  body      String
  // MySQL: no primitive list -> store as JSON array
  variables Json    @default("[]")

  userId   String
  tenantId String?
  isPublic Boolean @default(false)
  category String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id])
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([category])
}

enum RecipientType {
  TO
  CC
  BCC
}

model EmailRecipient {
  id String @id @default(uuid())

  emailId String
  email   Email @relation(fields: [emailId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id])

  isRead    Boolean       @default(false)
  isStarred Boolean       @default(false)
  folder    String        @default("inbox")
  type      RecipientType @default(TO)

  // spam metadata
  previousFolder String?
  spamReason     String? @db.Text
  spamScore      Float?
  spamFlags      Json?

  createdAt DateTime @default(now())

  @@unique([emailId, userId])

  @@index([userId, folder, isRead, createdAt(sort: Desc)])
  @@index([userId, folder, isStarred, createdAt(sort: Desc)])
  @@index([userId, folder, createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([emailId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, folder, spamScore])
}

enum AttachmentType {
  IMAGE
  VIDEO
  FILE
}

model EmailAttachment {
  id String @id @default(cuid())

  emailId String
  email   Email @relation(fields: [emailId], references: [id], onDelete: Cascade)

  fileId String
  file   File @relation(fields: [fileId], references: [id], onDelete: Cascade)

  type AttachmentType @default(FILE)

  createdAt DateTime @default(now())

  @@index([emailId])
}

// =====================
//        SESSION / AUTH
// =====================

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.Text
  userAgent String?  @db.Text

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId(length: 191)], map: "session_user_idx_v4")
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id         String @id
  accountId  String
  providerId String

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId], map: "account_user_idx_v4")
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier(length: 191)], map: "verification_identifier_idx_v4")
  @@index([expiresAt])
  @@map("verification")
}

model PasswordSetupToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId(length: 191)], map: "password_setup_token_user_idx_v4")
  @@index([expiresAt])
  @@map("password_setup_token")
}

// =====================
//    MULTI-TENANT + RBAC
// =====================

enum RoleScope {
  CENTRAL
  TENANT
}

enum EmailProvider {
  RESEND
  SMTP
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true)

  users       UserTenant[]
  userRoles   UserRole[]
  domains     TenantDomain[]
  folders     Folder[]
  files       File[]
  roles       Role[]
  permissions Permission[]

  emailTemplates EmailTemplate[]

  // one settings row per tenant
  appSettings         AppSettings?
  brandSettings       BrandSettings?
  companySettings     CompanySettings?
  emailSettings       EmailSettings?
  fileManagerSettings FileManagerSettings?

  storageSettings StorageSettings?

  backupSettings BackupSettings?
  backups        BackupHistory[]
  languages      Language[]

  ipSettings IpSettings?

  // ✅ Tours (central/global tours use tenantId = null)
  tours Tour[]

  @@index([slug])
  @@index([createdAt])
}

model TenantDomain {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  domain    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([domain])
  @@index([tenantId])
}

model Role {
  id    Int      @id @default(autoincrement())
  key   String
  name  String
  scope RoleScope

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles   UserRole[]
  permissions RolePermission[]

  @@unique([tenantId, key])
  @@index([tenantId])
}

model Permission {
  id   Int    @id @default(autoincrement())
  key  String
  name String

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles RolePermission[]

  @@unique([tenantId, key])
  @@index([tenantId])
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserTenant {
  id       String  @id @default(cuid())
  userId   String
  tenantId String
  isOwner  Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

model UserRole {
  id       String @id @default(cuid())
  userId   String
  roleId   Int
  tenantId String?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@unique([userId, roleId, tenantId])
  @@index([userId])
  @@index([roleId])
  @@index([tenantId])
}

// =====================
//      FILE MANAGER
// =====================

model Folder {
  id   String @id @default(cuid())
  name String

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Folder?  @relation("FolderChildren", fields: [parentId], references: [id])
  children Folder[] @relation("FolderChildren")

  createdById String
  createdBy   User @relation("UserFolders", fields: [createdById], references: [id])

  files File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([parentId])
  @@index([createdById])
  @@index([createdAt])
}

model File {
  id       String @id @default(cuid())
  name     String
  size     Int
  mimeType String
  url      String @db.LongText

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  folderId String?
  folder   Folder? @relation(fields: [folderId], references: [id])

  ownerId String
  owner   User @relation("UserFiles", fields: [ownerId], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isFavorite Boolean   @default(false)
  deletedAt  DateTime?

  emailAttachments EmailAttachment[]

  @@index([tenantId])
  @@index([folderId])
  @@index([ownerId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isFavorite])
}

// =====================
//      FILE SETTINGS
// =====================

model FileManagerSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  maxFileSizeMb             Int     @default(50)
  allowedExtensions         Json    @default("[]")
  autoEmptyRecycleBinDays   Int     @default(30)
  requireDeleteConfirmation Boolean @default(true)
  allowPublicSharing        Boolean @default(false)

  @@index([tenantId])
}

// =====================
//       APP SETTINGS
// =====================

model AppSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  timezone               String  @default("UTC")
  locale                 String  @default("en")
  dateFormat             String  @default("yyyy-MM-dd")
  timeFormat             String  @default("HH:mm")
  weekStartsOn           Int     @default(1)
  defaultTheme           String  @default("system")
  allowUserThemeOverride Boolean @default(true)
  enforceTwoFactor       Boolean @default(false)
  sessionTimeout         Int     @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model BrandSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  titleText  String @default("Hive")
  footerText String @default("Powered by Hive")

  logoLightUrl String? @db.LongText
  logoDarkUrl  String? @db.LongText
  faviconUrl   String? @db.LongText

  sidebarIconUrl String? @db.LongText

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model CompanySettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  companyName        String
  legalName          String?
  email              String?
  phone              String?
  website            String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  country            String?
  taxId              String?
  registrationNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model EmailSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider     EmailProvider @default(RESEND)
  fromName     String
  fromEmail    String
  replyToEmail String?

  // Optional SMTP config – non-secret
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpSecurity String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// =====================
//      LOCALIZATION
// =====================

model Language {
  id       String  @id @default(cuid())
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code      String
  name      String
  isDefault Boolean @default(false)
  isEnabled Boolean @default(true)

  translations Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isDefault])
  @@index([isEnabled])
}

// =====================
//     BACKUP SYSTEM
// =====================

model BackupSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  enabled   Boolean @default(false)
  frequency String  @default("DAILY")
  time      String  @default("00:00")
  retention Int     @default(7)

  notificationEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model BackupHistory {
  id       String  @id @default(cuid())
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  filename String
  path     String @db.Text
  size     BigInt
  status   String
  type     String

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([createdAt])
  @@index([status])
}

// =====================
//    CRON JOB REGISTRY
// =====================

model SystemCron {
  id          String  @id @default(cuid())
  key         String  @unique
  name        String
  description String?

  schedule String
  url      String

  lastRunAt   DateTime?
  lastStatus  String?
  lastMessage String?  @db.Text

  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enabled])
  @@index([lastRunAt])
}

// =====================
//     STORAGE SETTINGS
// =====================

model StorageSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  provider String @default("LOCAL")

  accessKeyId     String? @db.Text
  secretAccessKey String? @db.Text
  endpoint        String? @db.Text
  region          String? @db.Text
  bucket          String? @db.Text

  gdriveJson String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// =====================
//      IP RESTRICTION
// =====================

model IpSettings {
  id       String  @id @default(cuid())
  tenantId String? @unique
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  enabled  Boolean @default(false)
  strategy String  @default("ALLOW")

  allowList Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([enabled])
}

// =====================
//       APP TOURS
// =====================

model Tour {
  id       String  @id @default(cuid())

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // ✅ required (avoid NULL unique issues)
  tenantKey String

  key      String
  name     String
  isActive Boolean @default(true)
  version  Int     @default(1)

  steps TourStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantKey, key])
  @@index([tenantKey])
  @@index([key])
  @@index([isActive])
}


model TourStep {
  id     String @id @default(cuid())

  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // order within the tour (0..n)
  order Int @default(0)

  selector  String
  title     String
  body      String
  placement String @default("right") // "top" | "right" | "bottom" | "left"
  padding   Int?

  // optional fixed rect overrides (px)
  rectX      Int?
  rectY      Int?
  rectWidth  Int?
  rectHeight Int?

  // optional: only show this step on matching routes
  onlyPathPrefix String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ensure no duplicate order per tour
  @@unique([tourId, order])
  @@index([tourId])
  @@index([onlyPathPrefix])
}


model OfflineTestItem {
  id        String   @id @default(cuid())
  title     String
  body      String?
  createdBy String?  // optional if you want to attach user
  createdAt DateTime @default(now())
}
